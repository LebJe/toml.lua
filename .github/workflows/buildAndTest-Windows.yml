name: "Build and Test on Windows"
on: ["push", "pull_request"]

jobs:
    RunTestsOnWindowsLuaJIT:
        name: "Windows (Latest) - LuaJIT and LLVM"
        runs-on: "windows-latest"
        steps:
            - uses: "actions/checkout@v3"
            - name: "Install Dependencies"
              run: "choco install -y mingw cmake ninja"
            - name: "Build LuaJIT"
              run: "powershell scripts/buildLuaJIT.ps1"
            - name: "Install LuaRocks"
              run: "powershell scripts/installLuaRocks.ps1; mkdir LuaRocks/tree"
            - name: "Uninstall MinGW"
              run: "choco uninstall -y mingw"
            - name: "Build Project"
              run: |
                  New-Item -Path "LuaRocks\tree\luaRocksConfig.lua" -ItemType File
                  $env:LUAROCKS_CONFIG="$(Resolve-Path LuaRocks\tree\luaRocksConfig.lua)"
                  LuaRocks\luarocks.exe --lua-dir $(Resolve-Path LuaJIT\) --tree $(Resolve-Path LuaRocks\tree) config variables.LUA_LIBDIR "$(Resolve-Path LuaJIT\bin\)"
                  LuaRocks\luarocks.exe --lua-dir $(Resolve-Path LuaJIT\) --tree $(Resolve-Path LuaRocks\tree) config variables.LINK_FLAGS "$(Resolve-Path libs\lua51.lib)"
                  LuaRocks\luarocks.exe --lua-dir $(Resolve-Path LuaJIT\) --tree $(Resolve-Path LuaRocks\tree) config cmake_generator "Ninja Multi-Config"
                  LuaRocks\luarocks.exe --lua-dir $(Resolve-Path LuaJIT\) --tree $(Resolve-Path LuaRocks\tree)
                  LuaRocks\luarocks.exe --lua-dir $(Resolve-Path LuaJIT\) --tree $(Resolve-Path LuaRocks\tree) config
                  LuaRocks\luarocks.exe --lua-dir $(Resolve-Path LuaJIT\) --tree $(Resolve-Path LuaRocks\tree) make
                  ls build.luarocks -Recurse
            # - name: "Install busted"
            #   run: |
            #     choco install -y mingw
            #     LuaRocks/luarocks.exe --lua-dir $(Resolve-Path LuaJIT\) --tree $(Resolve-Path LuaRocks\tree) install busted
